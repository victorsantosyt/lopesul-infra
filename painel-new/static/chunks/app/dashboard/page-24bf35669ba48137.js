(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5105],{63:(e,t,a)=>{"use strict";var l=a(7260);a.o(l,"usePathname")&&a.d(t,{usePathname:function(){return l.usePathname}}),a.o(l,"useRouter")&&a.d(t,{useRouter:function(){return l.useRouter}})},3308:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>m});var l=a(5155),s=a(2115),n=a(63);function r(e){let{children:t}=e,[a,l]=(0,s.useState)(!1),r=(0,n.useRouter)(),i=(0,n.usePathname)();return((0,s.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/configuracoes",{cache:"no-store"}).then(e=>e.json()),t=!!(null==e?void 0:e.maintenance),a="undefined"!=typeof document&&document.cookie.includes("is_admin=1");if(t&&!a&&"/manutencao"!==i)return void r.replace("/manutencao");l(!0)}catch(e){l(!0)}})()},[r,i]),a)?t:null}let i=e=>(null!=e?e:0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),o=e=>new Date(e).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"});async function d(e){let{timeoutMs:t=4e3,signal:a,cache:l="no-store"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=new AbortController,n=setTimeout(()=>s.abort(),t);try{let t=await fetch(e,{signal:a||s.signal,cache:l}),n=await t.json().catch(()=>null);return{ok:t.ok,data:n}}finally{clearTimeout(n)}}function c(e){try{let t=sessionStorage.getItem(e);if(!t)return null;let{t:a,v:l}=JSON.parse(t);if(!a)return null;if(Date.now()-a>3e4)return{stale:!0,v:l};return{stale:!1,v:l}}catch(e){return null}}function u(e,t){try{sessionStorage.setItem(e,JSON.stringify({t:Date.now(),v:t}))}catch(e){}}function m(){var e,t;let[a,n]=(0,s.useState)(!0),[m,h]=(0,s.useState)(null),[x,v]=(0,s.useState)(null),[g,y]=(0,s.useState)([]),[f,k]=(0,s.useState)([]),[p,b]=(0,s.useState)({starlink:null,mikrotik:null,rttMs:null,identity:null}),j=(0,s.useRef)(!1);async function N(e){try{let o=await d("/api/mikrotik/status",{timeoutMs:3e3,signal:e,cache:"no-store"});if((null==o?void 0:o.ok)&&(null==o?void 0:o.data)){var t,a,l,s,n,r,i;let e=o.data,d=e.ok?"online":"offline",c=(null==(t=e.flags)?void 0:t.hasLink)&&(null==(a=e.flags)?void 0:a.pingSuccess)?"online":"offline",m=null!=(n=null!=(s=null==(l=e.flags)?void 0:l.rttMs)?s:e.rttMs)?n:null,h=null!=(i=null!=(r=e.identity)?r:e.routerId)?i:null;b({mikrotik:d,starlink:c,rttMs:m,identity:h}),u("dash:status:v1",{mikrotik:d,starlink:c,rttMs:m,identity:h});return}}catch(e){console.warn("Falha no /api/mikrotik/status, tentando fallback…")}try{let t=await d("/api/dispositivos/status",{timeoutMs:3e3,signal:e,cache:"no-store"});if((null==t?void 0:t.ok)&&Array.isArray(t.data)){let e=t.data.some(e=>(null==e?void 0:e.tipo)==="mikrotik"&&"online"===e.status),a=t.data.some(e=>(null==e?void 0:e.tipo)==="starlink"&&"online"===e.status);b({mikrotik:e?"online":"offline",starlink:a?"online":"offline",rttMs:null})}}catch(e){}}(0,s.useEffect)(()=>{if(j.current)return;j.current=!0;let e=new AbortController;h(null);let t=c("dash:dashboard:v1"),a=c("dash:ultimos:v1"),l=c("dash:sessoes:v1"),s=c("dash:status:v1");(null==t?void 0:t.v)&&v(t.v),(null==a?void 0:a.v)&&y(a.v),(null==l?void 0:l.v)&&k(l.v),(null==s?void 0:s.v)&&b(e=>({...e,...s.v})),((null==t?void 0:t.v)||(null==a?void 0:a.v)||(null==l?void 0:l.v))&&n(!1),(async()=>{try{var t,a,l,s,r,i,o;let[n,c,m]=await Promise.allSettled([d("/api/dashboard?days=30",{timeoutMs:4500,signal:e.signal}),d("/api/pagamentos?limit=5&status=pago",{timeoutMs:4500,signal:e.signal}),d("/api/sessoes?ativas=true&limit=10",{timeoutMs:4500,signal:e.signal})]);if("fulfilled"===n.status&&(null==(t=n.value)?void 0:t.ok)&&n.value.data&&(v(n.value.data),u("dash:dashboard:v1",n.value.data)),"fulfilled"===c.status&&(null==(a=c.value)?void 0:a.ok)){let e=Array.isArray(c.value.data)?c.value.data:null!=(r=null==(s=c.value.data)?void 0:s.items)?r:[];y(e),u("dash:ultimos:v1",e)}if("fulfilled"===m.status&&(null==(l=m.value)?void 0:l.ok)){let e=Array.isArray(m.value.data)?m.value.data:null!=(o=null==(i=m.value.data)?void 0:i.items)?o:[];k(e),u("dash:sessoes:v1",e)}}catch(e){console.error(e),h("Falha ao carregar dados do dashboard.")}finally{n(!1)}})(),N(e.signal);let r=setInterval(()=>N(e.signal),15e3);return()=>{clearInterval(r),e.abort()}},[]);let w=(0,s.useMemo)(()=>{var e,t,a,l,s,n;let r=null==x?void 0:x.kpis,i=null==x?void 0:x.inventario,o=null==x?void 0:x.operacao;return{receitaPeriodo:null!=(e=null==r?void 0:r.receita)?e:0,vendasPeriodo:null!=(t=null==r?void 0:r.qtdVendas)?t:0,acessosAtivos:null!=(a=null==o?void 0:o.sessoesAtivas)?a:0,operadores:null!=(l=null==o?void 0:o.operadores)?l:0,frotas:null!=(s=null==i?void 0:i.frotas)?s:0,dispositivos:null!=(n=null==i?void 0:i.dispositivos)?n:0}},[x]);return(0,l.jsx)(r,{children:(0,l.jsxs)("div",{className:"p-6 md:p-8 bg-[#F0F6FA] dark:bg-[#1a2233] min-h-screen transition-colors",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,l.jsx)("h1",{className:"text-2xl md:text-3xl font-bold text-gray-900 dark:text-white",children:"Dashboard"}),(0,l.jsx)("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:(null==x?void 0:x.periodo)?"Per\xedodo: ".concat(new Date(x.periodo.from).toLocaleDateString("pt-BR")," — ").concat(new Date(x.periodo.to).toLocaleDateString("pt-BR")):null})]}),(0,l.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[{title:"Receita (30 dias)",value:i(w.receitaPeriodo)},{title:"Vendas (30 dias)",value:w.vendasPeriodo},{title:"Acessos Ativos",value:w.acessosAtivos},{title:"Operadores",value:w.operadores}].map(e=>{let{title:t,value:s}=e;return(0,l.jsxs)("div",{className:"bg-blue-600 dark:bg-blue-700 text-white rounded-xl p-4 text-center shadow transition-colors",children:[(0,l.jsx)("div",{className:"text-sm opacity-90",children:t}),(0,l.jsx)("div",{className:"text-2xl font-bold",children:a?"…":null!=s?s:"--"})]},t)})}),(0,l.jsxs)("div",{className:"grid md:grid-cols-3 gap-6",children:[(0,l.jsxs)("div",{className:"bg-white dark:bg-[#232e47] rounded-xl p-4 shadow col-span-2 transition-colors",children:[(0,l.jsx)("h2",{className:"text-lg font-semibold mb-4 text-gray-800 dark:text-white",children:"Acessos Ativos"}),m?(0,l.jsx)("div",{className:"text-sm text-red-500",children:m}):(0,l.jsxs)("table",{className:"w-full text-sm text-gray-700 dark:text-gray-300",children:[(0,l.jsx)("thead",{className:"text-left border-b border-gray-200 dark:border-gray-600",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"text-gray-800 dark:text-white",children:"Cliente / IP"}),(0,l.jsx)("th",{className:"text-gray-800 dark:text-white",children:"Expira em"})]})}),(0,l.jsx)("tbody",{children:a?(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:2,className:"py-4 text-gray-400 dark:text-gray-500",children:"Carregando…"})}):f.length>0?f.map(e=>{var t,a,s;return(0,l.jsxs)("tr",{className:"border-b border-gray-200 dark:border-gray-600",children:[(0,l.jsx)("td",{className:"py-2",children:null!=(s=null!=(a=null!=(t=e.cliente)?t:e.ipCliente)?a:e.macCliente)?s:"—"}),(0,l.jsx)("td",{children:e.expiraEm?o(e.expiraEm):"—"})]},e.id)}):(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:2,className:"text-center py-4 text-gray-400 dark:text-gray-500",children:"Sem acessos no momento."})})})]})]}),(0,l.jsxs)("div",{className:"space-y-4",children:[(0,l.jsxs)("div",{className:"bg-white dark:bg-[#232e47] p-4 rounded-xl shadow transition-colors",children:[(0,l.jsx)("h3",{className:"font-semibold mb-2 text-gray-800 dark:text-white",children:"Starlink"}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"w-3 h-3 rounded-full ".concat("online"===p.starlink?"bg-green-500":"bg-gray-400")}),(0,l.jsxs)("span",{className:"text-gray-700 dark:text-gray-300",children:[null!=(e=p.starlink)?e:"Aguardando…",null!=p.rttMs&&"online"===p.starlink?" • ".concat(p.rttMs," ms"):""]})]})]}),(0,l.jsxs)("div",{className:"bg-white dark:bg-[#232e47] p-4 rounded-xl shadow transition-colors",children:[(0,l.jsx)("h3",{className:"font-semibold mb-2 text-gray-800 dark:text-white",children:"MikroTik"}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"w-3 h-3 rounded-full ".concat("online"===p.mikrotik?"bg-green-500":"bg-gray-400")}),(0,l.jsxs)("span",{className:"text-gray-700 dark:text-gray-300",children:[null!=(t=p.mikrotik)?t:"Aguardando…",p.identity?" • ".concat(p.identity):""]})]})]}),(0,l.jsxs)("div",{className:"bg-white dark:bg-[#232e47] p-4 rounded-xl shadow transition-colors",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3 text-gray-800 dark:text-white",children:"\xdaltimos Pagamentos"}),(0,l.jsx)("ul",{className:"text-sm space-y-2",children:a?(0,l.jsx)("li",{className:"text-gray-400 dark:text-gray-500",children:"Carregando…"}):g.length>0?g.map(e=>{var t,a;return(0,l.jsxs)("li",{className:"flex items-center justify-between",children:[(0,l.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:o(e.criadoEm)}),(0,l.jsx)("span",{className:"font-medium text-gray-800 dark:text-gray-100",children:null!=(a=null!=(t=e.descricao)?t:e.plano)?a:"Pagamento"}),(0,l.jsx)("span",{className:"font-semibold text-green-600 dark:text-green-400",children:i(e.valor)})]},e.id)}):(0,l.jsx)("li",{className:"text-gray-400 dark:text-gray-500",children:"Nenhum pagamento ainda."})})]})]})]})]})})}},4092:(e,t,a)=>{Promise.resolve().then(a.bind(a,3308))}},e=>{e.O(0,[8441,1255,7358],()=>e(e.s=4092)),_N_E=e.O()}]);